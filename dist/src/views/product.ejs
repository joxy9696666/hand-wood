<% 
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–∞–ª–µ—Ä–µ–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  var galleryImagesData = [];
  var additionalImages = [];
  if (product.image_path) {
    galleryImagesData.push(product.image_path);
  }
  if (images && images.length > 0) {
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∏—Å–∫–ª—é—á–∞—è –≥–ª–∞–≤–Ω—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é
    additionalImages = images.filter(img => img.image_path !== product.image_path);
    galleryImagesData = galleryImagesData.concat(additionalImages.map(img => img.image_path));
  }

  var content = `
    <section class="section">
      <div class="container">
        <!-- –•–ª–µ–±–Ω–∞—è –∫—Ä–æ—à–∫–∞ -->
        <div class="breadcrumb">
          <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
          <span>/</span>
          <a href="/gallery">–ö–∞—Ç–∞–ª–æ–≥</a>
          <span>/</span>
          ${product.category_name ? `<a href="/category/${product.category_id}">${product.category_name}</a>` : '<span>–¢–æ–≤–∞—Ä—ã</span>'}
          <span>/</span>
          <span style="color: var(--color-text-primary); font-weight: 600;">${product.name}</span>
        </div>

        <div class="product-grid">
          <!-- –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
          <div class="product-images">
            <div class="main-image-container">
              <div id="main-image" class="main-image-wrapper gallery-trigger" style="cursor: pointer;">
                ${product.image_path ? 
                  `<img src="${product.image_path}" alt="${product.name}" class="main-product-image" loading="eager">` :
                  `<img src="https://via.placeholder.com/500x500?text=${encodeURIComponent(product.name)}" alt="${product.name}" class="main-product-image" loading="eager">`
                }
              </div>
            </div>

            <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å lazy loading -->
            ${additionalImages && additionalImages.length > 0 ? `
              <div class="thumbnails-container">
                ${additionalImages.map((img, idx) => `
                  <div class="thumbnail-container gallery-trigger" data-index="${idx + 1}">
                    <img 
                      src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='80 80'%3E%3C/svg%3E"
                      data-src="${img.image_path}?w=150&q=80" 
                      alt="—Ñ–æ—Ç–æ ${idx + 1}" 
                      class="lazy-img thumbnail-img">
                    <noscript>
                      <img 
                        src="${img.image_path}" 
                        alt="—Ñ–æ—Ç–æ ${idx + 1}">
                    </noscript>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>

          <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–∞–ª–µ—Ä–µ–∏ -->
          <div id="galleryModal" class="gallery-modal">
            <div class="gallery-modal-content">
              <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
              <button class="gallery-close" id="galleryCloseBtn">‚úï</button>
              
              <!-- –°—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
              <button class="gallery-arrow gallery-arrow-left" id="galleryPrevBtn">‚ùÆ</button>
              <button class="gallery-arrow gallery-arrow-right" id="galleryNextBtn">‚ùØ</button>
              
              <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
              <img id="galleryImage" class="gallery-image" alt="–ü–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω–æ–µ —Ñ–æ—Ç–æ">
              
              <!-- –°—á—ë—Ç—á–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
              <div class="gallery-counter">
                <span id="currentImageNum">1</span> / <span id="totalImages">1</span>
              </div>
            </div>
          </div>

          <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
          <div class="product-info">
            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ -->
            <div class="product-header">
              <p class="section-subtitle">–ö–∞—Ç–∞–ª–æ–≥ HandWood</p>
              <h1>${product.name}</h1>
              ${product.category_name ? `
                <p class="product-category">
                  –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${product.category_name}
                </p>
              ` : ''}
            </div>

            <!-- –¶–µ–Ω–∞ –≤ –±–ª–æ–∫–µ -->
            <div class="price-block">
              <p class="price-label">–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞:</p>
              <h2 class="price-value">${product.price} ‚ÇΩ</h2>
            </div>

            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            ${product.description ? `
              <div class="product-description">
                <h3>–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h3>
                <p class="description-text">${product.description}</p>
              </div>
            ` : ''}

            <!-- –°–ï–ö–¶–ò–Ø: –†–ê–ó–ú–ï–† -->
            ${product.size_open || product.size_closed || product.weight_net || product.weight_gross || product.diameter ? `
              <div class="product-section">
                <details>
                  <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: 0.8rem 0; display: flex; align-items: center;">
                    <span style="margin-right: 0.8rem;">üìè</span> –†–∞–∑–º–µ—Ä
                  </summary>
                  <div style="padding: 1rem 0; border-left: 3px solid var(--color-accent-warm); padding-left: 1rem;">
                    ${product.size_open ? `<p><strong>–†–∞–∑–º–µ—Ä –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ:</strong> ${product.size_open}</p>` : ''}
                    ${product.size_closed ? `<p><strong>–†–∞–∑–º–µ—Ä –≤ –∑–∞–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ:</strong> ${product.size_closed}</p>` : ''}
                    ${product.weight_net ? `<p><strong>–ß–∏—Å—Ç—ã–π –≤–µ—Å:</strong> ${product.weight_net}</p>` : ''}
                    ${product.weight_gross ? `<p><strong>–í–µ—Å –±—Ä—É—Ç—Ç–æ (—Å —É–ø–∞–∫–æ–≤–∫–æ–π):</strong> ${product.weight_gross}</p>` : ''}
                    ${product.diameter ? `<p><strong>–î–∏–∞–º–µ—Ç—Ä –¥–µ—Ç–∞–ª–µ–π:</strong> ${product.diameter}</p>` : ''}
                  </div>
                </details>
              </div>
            ` : ''}

            <!-- –°–ï–ö–¶–ò–Ø: –ß–¢–û –°–û–î–ï–†–ñ–ò–¢ –ù–ê–ë–û–† -->
            ${product.contents ? `
              <div class="product-section">
                <details>
                  <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: 0.8rem 0; display: flex; align-items: center;">
                    <span style="margin-right: 0.8rem;">üì¶</span> –ß—Ç–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–±–æ—Ä
                  </summary>
                  <div style="padding: 1rem 0; border-left: 3px solid var(--color-accent-warm); padding-left: 1rem;">
                    <p style="white-space: pre-wrap; line-height: 1.6;">${product.contents}</p>
                  </div>
                </details>
              </div>
            ` : ''}

            <!-- –°–ï–ö–¶–ò–Ø: –î–û–°–¢–ê–í–ö–ê –ò –í–û–ó–í–†–ê–¢ -->
            ${product.delivery_return ? `
              <div class="product-section">
                <details>
                  <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: 0.8rem 0; display: flex; align-items: center;">
                    <span style="margin-right: 0.8rem;">üöö</span> –î–æ—Å—Ç–∞–≤–∫–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç
                  </summary>
                  <div style="padding: 1rem 0; border-left: 3px solid var(--color-accent-warm); padding-left: 1rem;">
                    <p style="white-space: pre-wrap; line-height: 1.6;">${product.delivery_return}</p>
                  </div>
                </details>
              </div>
            ` : ''}

            <!-- –°–ï–ö–¶–ò–Ø: –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –£–•–û–î–£ -->
            ${product.care_instructions ? `
              <div class="product-section">
                <details open>
                  <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: 0.8rem 0; display: flex; align-items: center;">
                    <span style="margin-right: 0.8rem;">üëï</span> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É—Ö–æ–¥—É
                  </summary>
                  <div style="padding: 1rem 0; border-left: 3px solid var(--color-accent-warm); padding-left: 1rem;">
                    <p style="white-space: pre-wrap; line-height: 1.6;">${product.care_instructions}</p>
                  </div>
                </details>
              </div>
            ` : ''}

            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫–∞–∑–∞ -->
            <a href="/order" class="btn-primary btn-order">
              –ó–∞–∫–∞–∑–∞—Ç—å —ç—Ç–æ –∏–∑–¥–µ–ª–∏–µ
            </a>

            <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
            <div class="product-contacts">
              <h3>–í–æ–ø—Ä–æ—Å—ã –æ —Ç–æ–≤–∞—Ä–µ?</h3>
              <p>–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –Ω–∞–ø—Ä—è–º—É—é –≤ –ª—é–±–æ–º —É–¥–æ–±–Ω–æ–º –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ</p>
              <div class="social-icons">
                <a href="https://api.whatsapp.com/send/?phone=37360860100&text&type=phone_number&app_absent=0" target="_blank" title="WhatsApp"><img src="/icons/whatsapp.svg" alt="WhatsApp"></a>
                <a href="viber://chat?number=%2B37360860100" target="_blank" title="Viber"><img src="/icons/viber.svg" alt="Viber"></a>
                <a href="https://t.me/Hand_Wood_MD" target="_blank" title="Telegram"><img src="/icons/telegram.svg" alt="Telegram"></a>
                <a href="https://www.instagram.com/handwoodmd?igsh=dXIwM2x3b2w3bGg3" target="_blank" title="Instagram"><img src="/icons/instagram.svg" alt="Instagram"></a>
              </div>
            </div>
          </div>
        </div>

        <!-- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç–æ–≤–∞—Ä—ã -->
        <div style="margin-top: 5rem; padding-top: 5rem; border-top: 2px solid var(--color-neutral-bg); text-align: center;">
          <h2 style="margin-bottom: 1rem;">–î—Ä—É–≥–∏–µ —Ä–∞–±–æ—Ç—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</h2>
          <a href="/gallery" class="btn-secondary">
            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã ‚Üí
          </a>
        </div>
      </div>
    </section>
  `;
  var galleryImagesDataStr = JSON.stringify(galleryImagesData);
%>

<script>
  // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è
  window.galleryImagesData = <%- JSON.stringify(galleryImagesData) %>;
  window.currentImageIndex = 0;

  // –û—Ç–∫—Ä—ã—Ç—å –≥–∞–ª–µ—Ä–µ—é
  window.openGallery = function(index) {
    if (!window.galleryImagesData || window.galleryImagesData.length === 0) {
      console.error('–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è');
      return;
    }
    
    window.currentImageIndex = Math.max(0, Math.min(index, window.galleryImagesData.length - 1));
    const modal = document.getElementById('galleryModal');
    const img = document.getElementById('galleryImage');
    
    if (!modal || !img) {
      console.error('–≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
      return;
    }
    
    img.src = window.galleryImagesData[window.currentImageIndex];
    document.getElementById('currentImageNum').textContent = window.currentImageIndex + 1;
    document.getElementById('totalImages').textContent = window.galleryImagesData.length;
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  // –ó–∞–∫—Ä—ã—Ç—å –≥–∞–ª–µ—Ä–µ—é
  window.closeGallery = function() {
    const modal = document.getElementById('galleryModal');
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  }

  // –°–ª–µ–¥—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  window.nextImage = function() {
    if (window.galleryImagesData.length === 0) return;
    window.currentImageIndex = (window.currentImageIndex + 1) % window.galleryImagesData.length;
    window.updateGalleryImage();
  }

  // –ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  window.prevImage = function() {
    if (window.galleryImagesData.length === 0) return;
    window.currentImageIndex = (window.currentImageIndex - 1 + window.galleryImagesData.length) % window.galleryImagesData.length;
    window.updateGalleryImage();
  }

  // –û–±–Ω–æ–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –≥–∞–ª–µ—Ä–µ–µ
  window.updateGalleryImage = function() {
    const img = document.getElementById('galleryImage');
    if (img) {
      img.src = window.galleryImagesData[window.currentImageIndex];
      document.getElementById('currentImageNum').textContent = window.currentImageIndex + 1;
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
  document.addEventListener('DOMContentLoaded', function() {
    // –ö–ª–∏–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ
    const mainImage = document.getElementById('main-image');
    if (mainImage) {
      mainImage.addEventListener('click', function() {
        window.openGallery(0);
      });
    }

    // –ö–ª–∏–∫–∏ –Ω–∞ –º–∏–Ω–∏–∞—Ç—é—Ä—ã
    const thumbnails = document.querySelectorAll('.thumbnail-container.gallery-trigger');
    thumbnails.forEach(thumb => {
      thumb.addEventListener('click', function(e) {
        const index = parseInt(this.getAttribute('data-index')) || 0;
        window.openGallery(index);
      });
    });

    // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const closeBtn = document.getElementById('galleryCloseBtn');
    const prevBtn = document.getElementById('galleryPrevBtn');
    const nextBtn = document.getElementById('galleryNextBtn');
    
    if (closeBtn) closeBtn.addEventListener('click', window.closeGallery);
    if (prevBtn) prevBtn.addEventListener('click', window.prevImage);
    if (nextBtn) nextBtn.addEventListener('click', window.nextImage);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ —Ñ–æ—Ç–æ
    const modal = document.getElementById('galleryModal');
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          window.closeGallery();
        }
      });
    }
  });

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
  document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('galleryModal');
    if (modal && modal.style.display === 'flex') {
      if (e.key === 'ArrowRight') window.nextImage();
      if (e.key === 'ArrowLeft') window.prevImage();
      if (e.key === 'Escape') window.closeGallery();
    }
  });
</script>

<%- include('layouts/main', { title, description: product.description || product.name, content }) %>
